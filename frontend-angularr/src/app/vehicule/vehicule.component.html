<div id="preloader-prestige" *ngIf="showPreloader">
  <div class="main-stage">
    <div class="orbit-container">
      <div class="ring gold"><div class="comet"></div></div>
      <div class="ring bordeaux"><div class="comet"></div></div>
      <div class="ring white"><div class="comet"></div></div>
      <div class="glass-sphere big-sphere">
        <img src="assets/agil.png" alt="SNDP Agil Logo" class="big-logo">
      </div>
    </div>

    <div class="text-area text-center">
      <h2 class="welcome-msg" style="color: black;">Initialisation <span class="admin-name">Système AGIL</span></h2>
      <div class="progress-section">
        <div class="luxury-bar">
          <div class="fill-permanent"></div>
        </div>
        <span class="loading-label">Chargement des infrastructures...</span>
      </div>
    </div>
  </div>
</div>

<app-adminlayoutcomponent></app-adminlayoutcomponent>

<div class="dashboard-wrapper">
  <div class="container py-4 animate-fade-in">
    
    <header class="mb-5">
      <div class="header-agil-prestige">
        <div class="decoration-side"></div>
        <div class="content-text">
          <div class="top-label">Interface de Contrôle</div>
          <h1 class="main-title">GÉRER LES <span class="highlight-gold">VÉHICULES</span></h1>
          <div class="bottom-bar">
            <span class="brand">AGIL</span>
            <span class="divider"></span>
            <span class="module">Gestion du Parc Automobile</span>
          </div>
        </div>
      </div>
      
    </header>

    <section class="stats-grid mb-5">
      <div class="row g-4 justify-content-center">
        <div class="col-12 col-md-4">
          <div class="stat-pod pod-bordeaux">
            <div class="pod-inner">
              <div class="orbit-container">
                <svg viewBox="0 0 100 100">
                  <circle class="orbit-bg" cx="50" cy="50" r="42"></circle>
                  <circle class="orbit-progress" cx="50" cy="50" r="42" 
                          [style.stroke-dashoffset]="264 - (264 * pourcentageDispo) / 100"></circle>
                </svg>
                <div class="orbit-center"><span class="num">{{ pourcentageDispo }}%</span></div>
              </div>
              <div class="pod-info">
                <span class="pod-title">Disponibilité</span>
                <span class="pod-subtitle">Flotte Opérationnelle</span>
              </div>
            </div>
          </div>
        </div>
        

        <div class="col-12 col-md-3">
          <div class="stat-pod pod-dark">
            <div class="pod-inner">
              <div class="pod-icon-circle"><i class="fas fa-car-side"></i></div>
              <div class="pod-data">
                <span class="big-val">{{ vehicules.length }}</span>
                <span class="pod-label">Unités Totales</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-3">
          <div class="stat-pod pod-gold">
            <div class="pod-inner">
              <div class="live-indicator"><span class="ping"></span><i class="fas fa-satellite-dish"></i></div>
              <div class="pod-data">
                <span class="big-val">{{ nombreEnMission }}</span>
                <span class="pod-label">Missions Live</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="analytics-bar mb-5">
      <div class="fleet-status-master">
        <div class="status-header">
          <span class="status-label">RÉPARTITION ANALYTIQUE DE LA FLOTTE</span>
          <span class="fleet-total">Parc : <strong>{{ vehicules.length }} Unités</strong></span>
        </div>
        <div class="prestige-progress-stack">
          <div class="segment dispo" [style.width.%]="pourcentageDispo" title="Disponibles">
            <span class="segment-label" *ngIf="pourcentageDispo > 10">{{ pourcentageDispo }}%</span>
          </div>
          <div class="segment mission" [style.width.%]="pourcentageMission" title="En Mission">
            <span class="segment-label" *ngIf="pourcentageMission > 10">{{ pourcentageMission }}%</span>
          </div>
          <div class="segment maintenance" [style.width.%]="pourcentageMaintenance" title="Maintenance">
            <span class="segment-label" *ngIf="pourcentageMaintenance > 10">{{ pourcentageMaintenance }}%</span>
          </div>
        </div>
        <div class="legend-container">
          <div class="legend-item"><span class="dot dispo"></span> Disponible</div>
          <div class="legend-item"><span class="dot mission"></span> Mission</div>
          <div class="legend-item"><span class="dot maintenance"></span> Entretien</div>
        </div>
      </div>
    </section>

    <div class="action-zone d-flex justify-content-center mb-5">
      <div class="magnetic-wrapper" *ngIf="!showForm">
        <button class="btn-agil-crystal" (click)="ouvrirFormulaireAjout()">
          <div class="btn-content">
            <span class="plus-icon"><i class="fas fa-plus"></i></span>
            <span class="btn-text">Ajouter au Parc</span>
          </div>
          <div class="crystal-blur"></div>
        </button>
      </div>
      <button *ngIf="showForm" class="btn-agil-outline" (click)="showForm = false">
        <i class="fas fa-times me-2"></i>Fermer le formulaire
      </button>
    </div>

    <section id="form-section" class="glass-form-container shadow-extra glass-panel mb-5" *ngIf="showForm">
      <div class="row g-0">
        <div class="col-lg-7 p-5 bg-white">
          <div class="d-flex align-items-center mb-4">
            <div class="icon-box-status" [ngClass]="isEdit ? 'bg-warning' : 'bg-success'">
              <i class="fas" [ngClass]="isEdit ? 'fa-edit' : 'fa-plus'"></i>
            </div>
            <h3 class="ms-3 fw-bold m-0">{{ isEdit ? 'Modification' : 'Nouvelle Unité' }}</h3>
          </div>
          
          <div class="row g-4">
            <div class="col-md-6 input-group-fancy">
              <label>Matricule Officiel</label>
              <input type="text" [(ngModel)]="currentVehicule.matricule" placeholder="200-TUN-1234">
            </div>
            <div class="col-md-6 input-group-fancy">
              <label>Affectation Site</label>
              <select [(ngModel)]="selectedLocalId">
                <option [value]="0">Parc Central</option>
                <option *ngFor="let l of locaux" [value]="l.idLocal">{{ l.nomLocal }}</option>
              </select>
            </div>
            <div class="col-md-6 input-group-fancy">
              <label>Marque & Modèle</label>
              <div class="d-flex gap-2">
                <input type="text" [(ngModel)]="currentVehicule.marque" placeholder="Marque" class="w-50">
                <input type="text" [(ngModel)]="currentVehicule.modele" placeholder="Modèle" class="w-50">
              </div>
            </div>
            <div class="col-md-6 input-group-fancy">
              <label>Spécifications</label>
              <div class="d-flex gap-2">
                <select [(ngModel)]="currentVehicule.carburant" class="w-50">
                  <option value="Diesel">Diesel</option>
                  <option value="Essence">Essence</option>
                </select>
                <input type="number" [(ngModel)]="currentVehicule.annee" placeholder="Année" class="w-50">
              </div>
            </div>
            <div class="col-md-12 input-group-fancy">
              <label>Statut de l'unité</label>
              <select [(ngModel)]="currentVehicule.etat">
                <option value="DISPONIBLE">DISPONIBLE</option>
                <option value="INDISPONIBLE">INDISPONIBLE</option>
                <option value="EN_ENTRETIEN">EN ENTRETIEN</option>
                <option value="EN_MISSION">EN MISSION</option>
              </select>
            </div>
            <div class="col-12 input-group-fancy">
              <label>URL Image (HD)</label>
              <input type="text" [(ngModel)]="currentVehicule.image" placeholder="Lien image...">
            </div>
          </div>

          <div class="mt-5 d-flex gap-3">
            <button class="btn-agil-main px-5" (click)="enregistrer()">
              <i class="fas fa-save me-2"></i>{{ isEdit ? 'Mettre à jour' : 'Enregistrer' }}
            </button>
            <button class="btn-agil-outline" (click)="showForm = false">Annuler</button>
          </div>
        </div>

        <div class="col-lg-5 p-0 d-none d-lg-block">
          <div class="preview-card-live" [style.backgroundImage]="'url(' + (currentVehicule.image || 'assets/no-car.png') + ')'">
            <div class="preview-overlay">
              <div class="preview-content">
                <span class="badge-status-live" [ngClass]="currentVehicule.etat">{{ currentVehicule.etat || 'STATUT' }}</span>
                <h2 class="text-white fw-bold mb-0">{{ currentVehicule.marque || 'VÉHICULE' }}</h2>
                <p class="text-gold-agil fs-4">{{ currentVehicule.modele || 'Modèle' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="list-section">
      <div class="table-container-prestige">
        <div class="table-header-fancy p-4 d-flex justify-content-between align-items-center">
          <h4 class="m-0 fw-bold"><i class="fas fa-list-ul me-2"></i>Registre de la Flotte</h4>
          <div class="table-badge-count">{{ vehicules.length }} Véhicules enregistrés</div>
        </div>
        
        <div class="table-responsive">
          <table class="table align-middle m-0">
            <thead>
              <tr class="header-prestige">
                <th class="ps-4">Identité du Véhicule</th>
                <th>Matricule</th>
                <th>Localisation</th>
                <th>Statut</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let v of vehicules" class="row-hover">
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="img-wrapper-premium"><img [src]="v.image || 'assets/no-car.png'"></div>
                    <div class="ms-3">
                      <div class="fw-bold text-dark">{{ v.marque }}</div>
                      <div class="text-muted small">{{ v.modele }} <span class="dot-separator"></span> {{ v.annee }}</div>
                    </div>
                  </div>
                </td>
                <td><div class="matricule-tag-modern"><span class="number-plate">{{ v.matricule }}</span></div></td>
                <td>
                  <div *ngIf="v.local; else noLocal" class="location-chip">
                    <i class="fas fa-map-marker-alt text-gold-agil me-2"></i>
                    {{ v.local.nomLocal }}
                  </div>
                  <ng-template #noLocal><span class="badge-unassigned">Non assigné</span></ng-template>
                </td>
                <td>
                  <div class="status-pill-modern" [ngClass]="v.etat">
                    <span class="status-dot"></span> {{ v.etat }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="action-bundle-modern">
                    <button class="btn-action-modern view" (click)="ouvrirConsultation(v)" title="Voir"><i class="fas fa-eye"></i></button>
                    <button class="btn-action-modern edit" (click)="preparerModif(v)" title="Modifier"><i class="fas fa-pen"></i></button>
                    <button class="btn-action-modern delete" (click)="supprimer(v.idVehicule)" title="Supprimer"><i class="fas fa-trash"></i></button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="modal-overlay" *ngIf="vehiculeEnConsultation" (click)="fermerConsultation()">
      <div class="card-consultation shadow-extra" (click)="$event.stopPropagation()">
        <div class="card-header-agil">
          <img src="https://www.agilenergy.com.tn/fr/images/logoagilenergy.jpg" alt="Logo AGIL" class="logo-small">
          <button class="close-btn" (click)="fermerConsultation()">&times;</button>
        </div>
        
        <div class="card-body-consultation">
          <div class="row align-items-center">
            <div class="col-lg-6 text-center">
              <div class="image-frame">
                <img [src]="vehiculeEnConsultation.image || 'assets/no-car.png'" class="img-fluid rounded shadow-lg">
              </div>
            </div>
            <div class="col-lg-6 p-4">
              <span class="category-label">FICHE TECHNIQUE OFFICIELLE</span>
              <h2 class="car-title text-uppercase">{{ vehiculeEnConsultation.marque }} <span>{{ vehiculeEnConsultation.modele }}</span></h2>
              <div class="big-matricule">{{ vehiculeEnConsultation.matricule }}</div>
              <hr class="gold-divider">
              <div class="details-grid">
                <div class="detail-item"><i class="fas fa-calendar-alt"></i> <span><strong>Année :</strong> {{ vehiculeEnConsultation.annee }}</span></div>
                <div class="detail-item"><i class="fas fa-gas-pump"></i> <span><strong>Carburant :</strong> {{ vehiculeEnConsultation.carburant }}</span></div>
                <div class="detail-item"><i class="fas fa-warehouse"></i> <span><strong>Site :</strong> {{ vehiculeEnConsultation.local?.nomLocal || 'N/A' }}</span></div>
                <div class="detail-item"><i class="fas fa-shield-alt"></i> <span><strong>Statut :</strong> {{ vehiculeEnConsultation.etat }}</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div> </div> 

